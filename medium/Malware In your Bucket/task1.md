# Task 1: Finding the infection

**Pontos Poss√≠veis:** 150  
**Penalidade de Dica:** 0  
**Pontos Dispon√≠veis:** 150

---

## üìñ Background

A ferramenta para escanear arquivos j√° foi escrita em Python e implantada na fun√ß√£o AWS Lambda `bucket-scan-function`. O bucket Amazon S3 usado para armazenar os arquivos a serem escaneados tem um nome que come√ßa com `file-scanning-upload-`.

Infelizmente, parece que algo foi mal configurado, pois toda vez que um arquivo √© enviado para escaneamento, nada acontece. A equipe que fez o deploy da ferramenta jura que tudo estava funcionando bem at√© que um novo bucket S3 foi criado e o anterior foi deletado.

Normalmente, a ferramenta deveria ser acionada automaticamente e exibiria qualquer malware encontrado em seus arquivos de log.

## üéØ Sua Tarefa

A equipe de desenvolvimento tem usado o arquivo `test_file.txt` para testar a ferramenta. H√° uma vulnerabilidade espec√≠fica nesse arquivo que, quando escaneado, fornece um nome espec√≠fico. Eles pediram que voc√™ corrija a solu√ß√£o de escaneamento e forne√ßa o **nome dessa vulnerabilidade** assim que o escaneamento for conclu√≠do.

O upload do arquivo no bucket S3 deve acionar automaticamente a fun√ß√£o AWS Lambda, que exibir√° o nome da vulnerabilidade em seus arquivos de log.

‚ö†Ô∏è **Nota:** Pode levar 30 segundos ap√≥s o upload para o Log Group ser criado pela primeira vez. Se voc√™ n√£o vir nenhum log stream ou receber um erro de que n√£o h√° Log Group criado, significa que voc√™ n√£o completou o desafio adequadamente.

## üì¶ Invent√°rio

- Um bucket Amazon S3 com nome que come√ßa com `file-scanning-upload-`
- Um arquivo de teste suspeito para escanear: `test_file.txt`
- Uma fun√ß√£o AWS Lambda chamada `bucket-scan-function`

## üõ†Ô∏è Servi√ßos que Voc√™ Deve Usar

- **AWS Lambda**
- **Amazon S3**
- **Amazon CloudWatch Logs**

## ‚úÖ Valida√ß√£o da Tarefa

Uma vez que o escaneamento √© realizado, ele fornecer√° um alerta em JSON. O valor da chave `detection_rule` √© a **resposta para este desafio**.

---

## üí° Solu√ß√£o Passo a Passo (Console AWS)

### 1Ô∏è‚É£ Encontre o bucket correto

1. Acesse **S3** ‚Üí **Buckets**
2. Encontre o bucket que come√ßa com `file-scanning-upload-`
3. Anote o nome completo do bucket

### 2Ô∏è‚É£ Configure o gatilho S3 ‚Üí Lambda

#### Op√ß√£o A: Configurar pelo Lambda (Recomendado)

1. V√° em **Lambda** ‚Üí **Functions** ‚Üí abra `bucket-scan-function`
2. Aba **Configuration** ‚Üí se√ß√£o **Triggers** ‚Üí **Add trigger**
3. Configure:
   - **Source:** S3
   - **Bucket:** escolha o `file-scanning-upload-...`
   - **Event type:** All object create events
   - **Prefix/Suffix:** deixe em branco
   - ‚úÖ Marque **Enable trigger**
4. Clique em **Add**

> üí° **Dica:** Fazendo pelo Lambda, ele j√° cria automaticamente a permiss√£o para o S3 invocar a fun√ß√£o. Se aparecer aviso de permiss√£o, aceite/confirme.

#### Op√ß√£o B: Configurar pelo S3 (Alternativa)

1. No bucket ‚Üí **Properties** ‚Üí **Event notifications** ‚Üí **Create event notification**
2. Configure:
   - **Name:** `invoke-lambda-on-upload`
   - **Event types:** All object create events
   - **Destination:** Lambda function ‚Üí `bucket-scan-function`
3. Clique em **Save**
4. Se aparecer aviso de permiss√£o, confirme para autorizar o S3 a invocar a Lambda

### 3Ô∏è‚É£ Verifique a role da Lambda (Logs & Leitura do S3)

1. Em **Lambda** ‚Üí `bucket-scan-function` ‚Üí **Configuration** ‚Üí **Permissions**
2. Em **Execution role**, clique no link da role
3. Confirme que a role possui:
   - Pol√≠tica **AWSLambdaBasicExecutionRole** (para escrever no CloudWatch Logs)
   - Permiss√£o para **s3:GetObject** no bucket `file-scanning-upload-*/*`

> ‚ö†Ô∏è **Nota:** Se houver pol√≠tica custom de S3, cheque se permite `s3:GetObject` no ARN correto. Muitos labs j√° deixam isso configurado.

### 4Ô∏è‚É£ Envie o arquivo de teste

1. V√° em **S3** ‚Üí abra o bucket `file-scanning-upload-...`
2. Clique em **Upload** ‚Üí adicione o `test_file.txt` ‚Üí **Upload**

‚è±Ô∏è **Observa√ß√£o:** A primeira execu√ß√£o pode levar ~30 segundos para o Log Group aparecer.

### 5Ô∏è‚É£ Leia a detec√ß√£o nos logs

1. Acesse **CloudWatch** ‚Üí **Logs** ‚Üí **Log groups** ‚Üí abra `/aws/lambda/bucket-scan-function`
2. Clique no **log stream mais recente** (topo da lista)
3. Procure a sa√≠da JSON do scanner (geralmente uma linha com campos `detection_rule`, `malware`, etc.)
4. O valor do campo **`detection_rule`** √© a resposta que voc√™ deve enviar

### 6Ô∏è‚É£ (Opcional) Use Logs Insights para extrair mais r√°pido

1. **CloudWatch Logs Insights** ‚Üí selecione o grupo `/aws/lambda/bucket-scan-function`
2. Execute a consulta:

```sql
fields @timestamp, @message
| filter @message like /detection_rule/
| parse @message /"detection_rule":"(?<detection_rule>[^"]+)"/
| stats latest(detection_rule) as detection_rule
```

3. O valor em `detection_rule` √© o que voc√™ precisa

---

## üîç Troubleshooting

### Problema: Nenhum log aparece no CloudWatch

**Poss√≠veis causas:**
- ‚úÖ Gatilho S3 n√£o configurado corretamente
- ‚úÖ Arquivo n√£o foi enviado para o bucket correto
- ‚úÖ Aguarde 30-60 segundos ap√≥s o upload

**Solu√ß√£o:**
- Verifique a aba **Triggers** da fun√ß√£o Lambda
- Confirme que o trigger est√° **Enabled**
- Envie o arquivo novamente

### Problema: Lambda retorna erro de permiss√£o

**Poss√≠veis causas:**
- ‚úÖ Role da Lambda n√£o tem permiss√£o para `s3:GetObject`
- ‚úÖ Role da Lambda n√£o tem permiss√£o para `logs:CreateLogGroup`

**Solu√ß√£o:**
- Verifique a execution role da Lambda
- Adicione as pol√≠ticas necess√°rias (AWSLambdaBasicExecutionRole + pol√≠tica S3)

### Problema: "No log group found"

**Poss√≠veis causas:**
- ‚úÖ Lambda nunca foi executada
- ‚úÖ Gatilho n√£o est√° funcionando

**Solu√ß√£o:**
- Verifique se o trigger est√° configurado corretamente
- Teste a Lambda manualmente primeiro

---

## üìö Conceitos Importantes

### S3 Event Notifications

Permite que buckets S3 enviem notifica√ß√µes quando certos eventos ocorrem:
- `s3:ObjectCreated:*` - Qualquer cria√ß√£o de objeto
- `s3:ObjectRemoved:*` - Qualquer remo√ß√£o de objeto
- `s3:ObjectRestore:*` - Restaura√ß√£o de objeto

### Lambda Event Source Mapping

Configura√ß√£o que permite que servi√ßos AWS invoquem fun√ß√µes Lambda automaticamente:
- **Push model:** S3, SNS, EventBridge (o servi√ßo invoca a Lambda)
- **Pull model:** SQS, Kinesis, DynamoDB Streams (Lambda consulta o servi√ßo)

### IAM Permissions

Dois tipos de permiss√µes necess√°rias:
1. **Execution Role:** O que a Lambda pode fazer (ex: ler de S3, escrever logs)
2. **Resource Policy:** Quem pode invocar a Lambda (ex: S3 bucket espec√≠fico)

---

## üéØ Checklist Final

- [ ] Bucket S3 identificado
- [ ] Trigger S3 ‚Üí Lambda configurado
- [ ] Trigger habilitado (Enabled)
- [ ] Execution role com permiss√µes corretas
- [ ] Resource policy permitindo S3 invocar Lambda
- [ ] Arquivo `test_file.txt` enviado
- [ ] Logs aparecendo no CloudWatch
- [ ] Campo `detection_rule` extra√≠do do JSON
- [ ] Resposta submetida

---

**üéâ Boa sorte!**
