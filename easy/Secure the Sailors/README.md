# ‚öì Secure the Sailors

## üìã Vis√£o Geral

Voc√™ foi contratado como desenvolvedor de jogos para "Sail to the Unknown". Uma das funcionalidades √© proteger os dados dos marinheiros (sailors), garantindo que o acesso seja baseado no princ√≠pio de "need to know" - usu√°rios devem ter acesso apenas √†s informa√ß√µes que sua fun√ß√£o de trabalho exige.

Este desafio ensina conceitos avan√ßados de seguran√ßa em bancos de dados usando **Amazon Redshift Serverless**, incluindo **Row-Level Security (RLS)** e **Column-Level Security (CLS)** para implementar controles granulares de acesso a dados.

## üéØ Objetivos de Aprendizado

- ‚úÖ Configurar Amazon Redshift Serverless e carregar dados
- ‚úÖ Implementar Column-Level Security (CLS) para controle de acesso por coluna
- ‚úÖ Implementar Row-Level Security (RLS) para controle de acesso por linha
- ‚úÖ Criar usu√°rios e roles com permiss√µes espec√≠ficas
- ‚úÖ Aplicar princ√≠pios de least privilege em bancos de dados
- ‚úÖ Validar pol√≠ticas de seguran√ßa atrav√©s de testes pr√°ticos
- ‚úÖ Entender o comportamento de RLS quando usu√°rios n√£o t√™m pol√≠ticas anexadas

## üèóÔ∏è Arquitetura

```
Amazon Redshift Serverless
‚îú‚îÄ‚îÄ Workgroup: seabird-wg
‚îú‚îÄ‚îÄ Namespace: seabird-nm
‚îú‚îÄ‚îÄ Database: dev
‚îú‚îÄ‚îÄ Tabela: sailors
‚îÇ   ‚îú‚îÄ‚îÄ Column-Level Security (CLS)
‚îÇ   ‚îî‚îÄ‚îÄ Row-Level Security (RLS)
‚îú‚îÄ‚îÄ Roles: captain, crew, finance
‚îî‚îÄ‚îÄ Users: cook, cuddy, cashking, pirate
```

## üõ†Ô∏è Servi√ßos Utilizados

- **Amazon Redshift Serverless** - Data warehouse para an√°lise de dados
- **AWS Secrets Manager** - Armazenamento seguro de credenciais
- **Amazon S3** - Fonte de dados para carregamento
- **IAM** - Roles para acesso ao S3

## üìö Conceitos Principais

### 1. **Column-Level Security (CLS)**
- Controle de acesso baseado em colunas espec√≠ficas
- Usu√°rios veem apenas colunas autorizadas
- Implementado via GRANT SELECT em colunas espec√≠ficas

### 2. **Row-Level Security (RLS)**
- Controle de acesso baseado em linhas/filtros
- Pol√≠ticas que determinam quais linhas s√£o vis√≠veis
- Usu√°rios sem pol√≠ticas anexadas veem zero linhas

### 3. **Princ√≠pio de Need-to-Know**
- Acesso baseado em fun√ß√£o de trabalho
- Diferentes n√≠veis de acesso por role
- Prote√ß√£o de dados sens√≠veis (PII)

## üöÄ Passo a Passo Detalhado

### **Task 1: All Aboard - Configura√ß√£o Inicial**

#### 1. **Conectar ao Redshift Serverless**

1. Navegue para **Redshift** ‚Üí **Query Editor V2**
2. Conecte ao workgroup `seabird-wg`
3. **Autentica√ß√£o:** Database user name and password
   - **Username:** `awsuser`
   - **Password:** Recupere de `RedshiftServerlessSecret-*` no Secrets Manager
   - **Database:** `dev`

#### 2. **Criar Tabela Sailors**

```sql
CREATE TABLE IF NOT EXISTS public.sailors (
  s_id               BIGINT,
  s_name             VARCHAR(25),
  s_address          VARCHAR(40),
  s_phone            VARCHAR(15),
  s_acctbal          NUMERIC(12,2),
  s_segment          VARCHAR(10),
  s_dietrestrictions VARCHAR(20),
  s_onboard          BOOLEAN
);
```

#### 3. **Carregar Dados do S3**

```sql
COPY public.sailors (
  s_id, s_name, s_address, s_phone, s_acctbal,
  s_segment, s_dietrestrictions, s_onboard
)
FROM 's3://redshift-demos/data/gamejam/sailors'
IAM_ROLE 'arn:aws:iam::370381165256:role/Redshiftgamesrole';
```

#### 4. **Criar Usu√°rios e Roles**

```sql
-- Criar roles
CREATE ROLE captain;
CREATE ROLE crew;
CREATE ROLE finance;

-- Criar usu√°rios
CREATE USER cook     PASSWORD 'Cook_P@ssw0rd!';
CREATE USER cuddy    PASSWORD 'Cuddy_P@ssw0rd!';
CREATE USER cashking PASSWORD 'Cash_P@ssw0rd!';

-- Atribuir roles aos usu√°rios
GRANT ROLE captain TO USER cook;
GRANT ROLE crew    TO USER cuddy;
GRANT ROLE finance TO USER cashking;
```

#### 5. **Responder Pergunta de Neg√≥cio**

```sql
SELECT COUNT(*) AS diamond_onboard
FROM public.sailors
WHERE s_onboard = TRUE
  AND LOWER(TRIM(s_segment)) = 'diamond';
```

### **Task 2: Secure Sailors - Implementar Seguran√ßa**

#### 1. **Remover Permiss√µes P√∫blicas**

```sql
REVOKE ALL ON TABLE public.sailors FROM PUBLIC;
```

#### 2. **Implementar Column-Level Security**

```sql
-- Captain: acesso a todas as colunas
GRANT SELECT ON TABLE public.sailors TO ROLE captain;

-- Crew: apenas nome, segmento e dieta
GRANT SELECT (s_name, s_segment, s_dietrestrictions)
ON TABLE public.sailors TO ROLE crew;

-- Finance: apenas nome, endere√ßo e saldo
GRANT SELECT (s_name, s_address, s_acctbal)
ON TABLE public.sailors TO ROLE finance;
```

#### 3. **Implementar Row-Level Security**

```sql
-- Pol√≠tica para todas as linhas (captain e finance)
CREATE RLS POLICY rls_all_rows
WITH (s_onboard BOOLEAN) AS s
USING (TRUE);

-- Pol√≠tica apenas para onboard (crew)
CREATE RLS POLICY rls_only_onboard
WITH (s_onboard BOOLEAN) AS s
USING (s.s_onboard = TRUE);

-- Anexar pol√≠ticas √†s roles
ATTACH RLS POLICY rls_all_rows     ON TABLE public.sailors TO ROLE captain;
ATTACH RLS POLICY rls_all_rows     ON TABLE public.sailors TO ROLE finance;
ATTACH RLS POLICY rls_only_onboard ON TABLE public.sailors TO ROLE crew;

-- Habilitar RLS na tabela
ALTER TABLE public.sailors ENABLE ROW LEVEL SECURITY;
```

#### 4. **Validar Implementa√ß√£o**

```sql
-- Verificar quantas linhas cada role v√™
SELECT
  COUNT(*) AS total_rows,
  COUNT(CASE WHEN s_onboard THEN 1 END) AS total_onboard
FROM public.sailors;
```

### **Task 3: Watch for Pirates - Testar Seguran√ßa**

#### 1. **Criar Usu√°rio Pirate**

```sql
-- Criar usu√°rio pirate
CREATE USER pirate PASSWORD 'Pirate_P@ssw0rd!';

-- Conceder permiss√µes totais
GRANT USAGE ON SCHEMA public TO pirate;
GRANT ALL ON TABLE public.sailors TO pirate;
```

#### 2. **Testar Acesso do Pirate**

```sql
-- Fazer login como pirate
SET SESSION AUTHORIZATION 'pirate';

-- Tentar consultar a tabela
SELECT COUNT(*) FROM public.sailors;
```

#### 3. **Monitorar Pol√≠ticas de Seguran√ßa**

```sql
-- Ver tabelas protegidas por RLS
SELECT * FROM SVV_RLS_RELATION;

-- Ver pol√≠ticas de RLS criadas
SELECT * FROM SVV_RLS_POLICY;

-- Ver pol√≠ticas anexadas
SELECT * FROM SVV_RLS_ATTACHED_POLICY;

-- Ver aplica√ß√£o de pol√≠ticas
SELECT * FROM SVV_RLS_APPLIED_POLICY;
```

## üîç Valida√ß√£o

### **Task 1 - Crit√©rios de Sucesso**
- [ ] Tabela sailors criada com estrutura correta
- [ ] Dados carregados do S3 com sucesso
- [ ] Usu√°rios e roles criados
- [ ] Roles atribu√≠dos aos usu√°rios
- [ ] Pergunta sobre sailors Diamond respondida

### **Task 2 - Crit√©rios de Sucesso**
- [ ] Permiss√µes p√∫blicas revogadas
- [ ] Column-Level Security implementada
- [ ] Row-Level Security implementada
- [ ] Pol√≠ticas anexadas √†s roles corretas
- [ ] RLS habilitado na tabela
- [ ] Usu√°rio cuddy v√™ apenas sailors onboard

### **Task 3 - Crit√©rios de Sucesso**
- [ ] Usu√°rio pirate criado
- [ ] Permiss√µes totais concedidas
- [ ] Pirate v√™ 0 linhas (sem pol√≠ticas RLS)
- [ ] Comportamento de seguran√ßa validado

## üéì Conceitos Aprendidos

### **Amazon Redshift Serverless**
- **Configura√ß√£o** de workgroups e namespaces
- **Carregamento** de dados via COPY do S3
- **Autentica√ß√£o** via Secrets Manager
- **Query Editor V2** para execu√ß√£o de comandos

### **Seguran√ßa em Bancos de Dados**
- **Column-Level Security** para controle granular de colunas
- **Row-Level Security** para filtros baseados em dados
- **Princ√≠pio de least privilege** aplicado a dados
- **Pol√≠ticas de acesso** baseadas em roles

### **Controle de Acesso Baseado em Fun√ß√£o**
- **Captain:** Acesso total a todos os dados
- **Crew:** Apenas dados de sailors onboard + colunas espec√≠ficas
- **Finance:** Dados financeiros de todos os sailors
- **Pirate:** Demonstra que permiss√µes sem pol√≠ticas RLS = 0 linhas

## ‚ö†Ô∏è Pontos de Aten√ß√£o

### **Configura√ß√£o de RLS**
- **RLS habilitado** significa que usu√°rios sem pol√≠ticas veem 0 linhas
- **Pol√≠ticas devem ser anexadas** √†s roles, n√£o aos usu√°rios
- **Ordem de execu√ß√£o** importa: criar pol√≠ticas antes de anexar

### **Permiss√µes de Coluna**
- **GRANT SELECT** em colunas espec√≠ficas limita visibilidade
- **Usu√°rios sem permiss√£o** em colunas recebem erro de acesso
- **Combina√ß√£o** de CLS + RLS oferece controle total

### **Ambiente de Teste**
- **SET SESSION AUTHORIZATION** simula login de outros usu√°rios
- **Valida√ß√£o** pode ser feita com awsuser consultando contadores
- **Sistema tables** (SVV_*) mostram configura√ß√µes de seguran√ßa

## üîß Troubleshooting Comum

### **Erro de COPY do S3**
- Verifique se a IAM role tem permiss√µes no bucket
- Confirme o caminho do S3 est√° correto
- Teste com formato espec√≠fico se necess√°rio

### **RLS n√£o funciona**
- Verifique se RLS est√° habilitado na tabela
- Confirme se pol√≠ticas est√£o anexadas √†s roles
- Teste com usu√°rio que tem pol√≠tica anexada

### **Usu√°rio v√™ 0 linhas**
- Verifique se usu√°rio tem role com pol√≠tica RLS
- Confirme se pol√≠tica est√° corretamente anexada
- Teste com awsuser para validar dados existem

## üìñ Recursos Adicionais

### **Documenta√ß√£o AWS**
- [Redshift Serverless](https://docs.aws.amazon.com/redshift/latest/mgmt/serverless-overview.html)
- [Row-Level Security](https://docs.aws.amazon.com/redshift/latest/dg/t_rls.html)
- [Column-Level Security](https://docs.aws.amazon.com/redshift/latest/dg/t_column_level_security.html)
- [Query Editor V2](https://docs.aws.amazon.com/redshift/latest/mgmt/query-editor-v2.html)

### **Boas Pr√°ticas de Seguran√ßa**
- **Princ√≠pio de least privilege** em todos os acessos
- **Separa√ß√£o de responsabilidades** por roles
- **Auditoria regular** de permiss√µes
- **Testes de seguran√ßa** com usu√°rios n√£o autorizados

### **Pr√≥ximos Passos**
- **Implementar** RLS em outras tabelas sens√≠veis
- **Configurar** alertas para tentativas de acesso n√£o autorizado
- **Integrar** com sistemas de auditoria
- **Automatizar** provisionamento de usu√°rios e roles

## üèÜ Crit√©rios de Sucesso

- [ ] **Compreens√£o:** Entender conceitos de RLS e CLS
- [ ] **Implementa√ß√£o:** Configurar seguran√ßa corretamente
- [ ] **Valida√ß√£o:** Testar diferentes n√≠veis de acesso
- [ ] **Troubleshooting:** Resolver problemas de permiss√£o
- [ ] **Aplica√ß√£o:** Transferir conhecimento para cen√°rios reais

## üéØ Cen√°rios de Aplica√ß√£o

### **Ambiente Corporativo**
- **Controle de acesso** a dados financeiros
- **Separa√ß√£o** entre dados de produ√ß√£o e desenvolvimento
- **Compliance** com regulamenta√ß√µes de privacidade
- **Auditoria** de acessos a dados sens√≠veis

### **Multi-tenant Applications**
- **Isolamento** de dados entre clientes
- **Controle granular** de acesso por tenant
- **Seguran√ßa** em aplica√ß√µes SaaS
- **Escalabilidade** de pol√≠ticas de seguran√ßa

---

**üéâ Parab√©ns!** Voc√™ implementou com sucesso controles avan√ßados de seguran√ßa em Amazon Redshift Serverless, incluindo Row-Level Security e Column-Level Security. Estes conceitos s√£o fundamentais para proteger dados sens√≠veis em ambientes de data warehouse.

> **üí° Dica:** RLS e CLS s√£o ferramentas poderosas para implementar seguran√ßa em profundidade. Use-as sempre que precisar de controle granular de acesso a dados, especialmente em ambientes com m√∫ltiplos usu√°rios e dados sens√≠veis.
