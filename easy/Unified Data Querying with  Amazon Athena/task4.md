# Task 4 – MySQL Federated Query with Amazon Athena

## 🎯 Objetivo
Consultar o **RDS MySQL** via **Amazon Athena Federated Query** (catálogo `mysql_dc`, database `game`) para obter o **title** do campeão com `champName = 'Morgana'`. Opcionalmente, realizar um **JOIN entre DynamoDB e MySQL**.

## 📋 Contexto do Ambiente

### Configuração Prévia:
- **Data Source MySQL:** `mysql_dc` (conector RDS MySQL)
- **Database/Schema:** `game`
- **Data Source DynamoDB:** `dynamo_dc` (para JOIN opcional)
- **Query Result Location:** Configurado (bucket S3)

### Estrutura dos Dados:
- **champName:** Nome do campeão (filtro: 'Morgana')
- **title:** Título do campeão (resposta desejada)
- **id:** Identificador numérico (para JOIN)

## 🔧 Implementação Tentada

### 1️⃣ Configuração do Ambiente Athena
**Localização:** AWS Console → Amazon Athena → Query Editor

**Passos Executados:**
1. **Acessei o Athena Console**
   - Naveguei para Amazon Athena
   - Cliquei em "Query editor"

2. **Verifiquei Settings**
   - `Workgroup = primary`
   - `Athena Engine = v3`
   - `Query result location` configurado em S3

3. **Alterei Data Source**
   - Mudei de `AwsDataCatalog` para `mysql_dc`
   - Tentei selecionar Database = `game` (não carregava na UI)

4. **Verifiquei Configuração do Conector**
   - Lambda ARN: `arn:aws:lambda:us-east-1:796492322457:function:mysql`
   - Nenhum database listado em "Associated databases"
   - Erro ao testar Lambda diretamente (esperado para Athena)

### 2️⃣ Queries Tentadas

#### Queries Diretas (MySQL):
```sql
SELECT title FROM mysql_dc.game.champions WHERE champName = 'Morgana' LIMIT 1;
SELECT title FROM mysql_dc.game.champion_titles WHERE champName = 'Morgana' LIMIT 1;
SELECT title FROM mysql_dc.game.titles WHERE champName = 'Morgana' LIMIT 1;
```

#### Query com JOIN (DynamoDB + MySQL):
```sql
SELECT DISTINCT r.title
FROM "mysql_dc"."game"."champion" r
JOIN "dynamo_dc"."default"."labstack-prewarm-006648d6-ba12-45fe-ad1c-3d7720bee0ee-cjxauxtxnequokhmgg6w4c-1-dynamodbtable-htuvkwbqig97" d
  ON CAST(d.champid AS INTEGER) = r.id
WHERE d.champname = 'Morgana'
LIMIT 1;
```

### 3️⃣ Alternativas Testadas
- **Queries totalmente qualificadas** (sem depender do dropdown)
- **Uso de SET CATALOG e USE**
- **Query do Clue 2** (JOIN DynamoDB + MySQL)
- **Refresh de catálogo** e troca AwsDataCatalog ↔ mysql_dc

## 🚨 Problema Identificado

### Erro Encontrado:
```
GENERIC_USER_ERROR: Encountered an exception[java.lang.IllegalArgumentException] from your LambdaFunction
with message [URLDecoder: Illegal hex characters in escape (%) pattern - Error at index 0 in: ":6"]
```

### Análise do Problema:
- **Não é erro de sintaxe SQL** - ocorre na fase de "retrieving meta-data"
- **Problema no conector federado** do MySQL (`mysql_dc`)
- **Causa identificada:** Senha MySQL contém caractere `&`

### Explicação Técnica:
> "This issue occurs when the password of MySQL contains the character &. Because the username and the password are specified in the query strings of Athena connector, but the query strings are divided by the character &. To avoid this issue, the & has to be excluded from the password generated by CloudFormation."

**Root Cause:** CloudFormation do lab gerou credenciais inválidas para o conector Athena-MySQL.

## 📊 Status da Task 4

### ❌ **BLOQUEADA** - Problema de Infraestrutura
- **Não é possível conectar** ao MySQL via Athena no estado atual do lab
- **Todas as alternativas foram tentadas** sem sucesso
- **Problema está no provisionamento** do ambiente de lab

### 🔧 Soluções Necessárias:
1. **Ajuste no provisionamento do lab:** Gerar senha MySQL sem caractere `&`
2. **Reprovisionar o conector** `mysql_dc` após corrigir a senha
3. **Reexecutar queries** após correção do conector

## 📝 Query Correta (Após Correção)

### Query Principal:
```sql
SELECT DISTINCT r.title
FROM "mysql_dc"."game"."champion" r
JOIN "dynamo_dc"."default"."<tabela-dynamodb>" d
  ON CAST(d.champid AS INTEGER) = r.id
WHERE d.champname = 'Morgana'
LIMIT 1;
```

### Instruções de Submissão:
1. **Execute a query** após correção do conector
2. **Copie o valor** da coluna `title`
3. **Cole no campo** "Enter answer here" do lab
4. **Clique em Submit**

## 🎓 Conceitos Aprendidos

### 🔗 Athena Federated Query:
- **Consulta federada** permite acessar múltiplas fontes de dados
- **MySQL connector** integra dados relacionais com SQL
- **JOIN federado** combina dados de diferentes fontes
- **Dependência de configuração** adequada do conector

### 🚨 Troubleshooting de Conectores:
- **Problemas de credenciais** podem bloquear conectores federados
- **Caracteres especiais** em senhas podem causar falhas de parsing
- **Validação de conectores** é essencial antes de executar queries
- **Issues de lab** podem ser problemas de infraestrutura, não de código

### 📊 Consultas SQL Avançadas:
- **JOIN entre data sources** diferentes (DynamoDB + MySQL)
- **CAST()** para conversão de tipos entre fontes
- **Queries totalmente qualificadas** para evitar dependência de UI
- **DISTINCT** para evitar duplicatas em JOINs

## 🏆 Resultado Final

### ❌ **Task 4 NÃO Concluída**
- **Problema de infraestrutura** do lab impediu execução
- **Conhecimento adquirido** sobre troubleshooting de conectores
- **Queries preparadas** para execução após correção do ambiente

### 📋 Próximos Passos:
1. **Aguardar correção** do ambiente de lab
2. **Reexecutar queries** após correção do conector
3. **Submeter resultado** quando ambiente estiver funcional

---

**💡 Reflexão:** Esta task demonstra a importância de troubleshooting de infraestrutura em ambientes de lab, onde problemas de provisionamento podem impedir a execução de soluções tecnicamente corretas. O conhecimento sobre conectores federados e troubleshooting foi adquirido mesmo sem conclusão da task.