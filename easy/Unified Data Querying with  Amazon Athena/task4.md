# Task 4 â€“ MySQL Federated Query with Amazon Athena

## ğŸ¯ Objetivo
Consultar o **RDS MySQL** via **Amazon Athena Federated Query** (catÃ¡logo `mysql_dc`, database `game`) para obter o **title** do campeÃ£o com `champName = 'Morgana'`. Opcionalmente, realizar um **JOIN entre DynamoDB e MySQL**.

## ğŸ“‹ Contexto do Ambiente

### ConfiguraÃ§Ã£o PrÃ©via:
- **Data Source MySQL:** `mysql_dc` (conector RDS MySQL)
- **Database/Schema:** `game`
- **Data Source DynamoDB:** `dynamo_dc` (para JOIN opcional)
- **Query Result Location:** Configurado (bucket S3)

### Estrutura dos Dados:
- **champName:** Nome do campeÃ£o (filtro: 'Morgana')
- **title:** TÃ­tulo do campeÃ£o (resposta desejada)
- **id:** Identificador numÃ©rico (para JOIN)

## ğŸ”§ ImplementaÃ§Ã£o Tentada

### 1ï¸âƒ£ ConfiguraÃ§Ã£o do Ambiente Athena
**LocalizaÃ§Ã£o:** AWS Console â†’ Amazon Athena â†’ Query Editor

**Passos Executados:**
1. **Acessei o Athena Console**
   - Naveguei para Amazon Athena
   - Cliquei em "Query editor"

2. **Verifiquei Settings**
   - `Workgroup = primary`
   - `Athena Engine = v3`
   - `Query result location` configurado em S3

3. **Alterei Data Source**
   - Mudei de `AwsDataCatalog` para `mysql_dc`
   - Tentei selecionar Database = `game` (nÃ£o carregava na UI)

4. **Verifiquei ConfiguraÃ§Ã£o do Conector**
   - Lambda ARN: `arn:aws:lambda:us-east-1:796492322457:function:mysql`
   - Nenhum database listado em "Associated databases"
   - Erro ao testar Lambda diretamente (esperado para Athena)

### 2ï¸âƒ£ Queries Tentadas

#### Queries Diretas (MySQL):
```sql
SELECT title FROM mysql_dc.game.champions WHERE champName = 'Morgana' LIMIT 1;
SELECT title FROM mysql_dc.game.champion_titles WHERE champName = 'Morgana' LIMIT 1;
SELECT title FROM mysql_dc.game.titles WHERE champName = 'Morgana' LIMIT 1;
```

#### Query com JOIN (DynamoDB + MySQL):
```sql
SELECT DISTINCT r.title
FROM "mysql_dc"."game"."champion" r
JOIN "dynamo_dc"."default"."labstack-prewarm-006648d6-ba12-45fe-ad1c-3d7720bee0ee-cjxauxtxnequokhmgg6w4c-1-dynamodbtable-htuvkwbqig97" d
  ON CAST(d.champid AS INTEGER) = r.id
WHERE d.champname = 'Morgana'
LIMIT 1;
```

### 3ï¸âƒ£ Alternativas Testadas
- **Queries totalmente qualificadas** (sem depender do dropdown)
- **Uso de SET CATALOG e USE**
- **Query do Clue 2** (JOIN DynamoDB + MySQL)
- **Refresh de catÃ¡logo** e troca AwsDataCatalog â†” mysql_dc

## ğŸš¨ Problema Identificado

### Erro Encontrado:
```
GENERIC_USER_ERROR: Encountered an exception[java.lang.IllegalArgumentException] from your LambdaFunction
with message [URLDecoder: Illegal hex characters in escape (%) pattern - Error at index 0 in: ":6"]
```

### AnÃ¡lise do Problema:
- **NÃ£o Ã© erro de sintaxe SQL** - ocorre na fase de "retrieving meta-data"
- **Problema no conector federado** do MySQL (`mysql_dc`)
- **Causa identificada:** Senha MySQL contÃ©m caractere `&`

### ExplicaÃ§Ã£o TÃ©cnica:
> "This issue occurs when the password of MySQL contains the character &. Because the username and the password are specified in the query strings of Athena connector, but the query strings are divided by the character &. To avoid this issue, the & has to be excluded from the password generated by CloudFormation."

**Root Cause:** CloudFormation do lab gerou credenciais invÃ¡lidas para o conector Athena-MySQL.

## ğŸ“Š Status da Task 4

### âŒ **BLOQUEADA** - Problema de Infraestrutura
- **NÃ£o Ã© possÃ­vel conectar** ao MySQL via Athena no estado atual do lab
- **Todas as alternativas foram tentadas** sem sucesso
- **Problema estÃ¡ no provisionamento** do ambiente de lab

### ğŸ”§ SoluÃ§Ãµes NecessÃ¡rias:
1. **Ajuste no provisionamento do lab:** Gerar senha MySQL sem caractere `&`
2. **Reprovisionar o conector** `mysql_dc` apÃ³s corrigir a senha
3. **Reexecutar queries** apÃ³s correÃ§Ã£o do conector

## ğŸ“ Query Correta (ApÃ³s CorreÃ§Ã£o)

### Query Principal:
```sql
SELECT DISTINCT r.title
FROM "mysql_dc"."game"."champion" r
JOIN "dynamo_dc"."default"."<tabela-dynamodb>" d
  ON CAST(d.champid AS INTEGER) = r.id
WHERE d.champname = 'Morgana'
LIMIT 1;
```

### InstruÃ§Ãµes de SubmissÃ£o:
1. **Execute a query** apÃ³s correÃ§Ã£o do conector
2. **Copie o valor** da coluna `title`
3. **Cole no campo** "Enter answer here" do lab
4. **Clique em Submit**

## ğŸ“ Conceitos Aprendidos

### ğŸ”— Athena Federated Query:
- **Consulta federada** permite acessar mÃºltiplas fontes de dados
- **MySQL connector** integra dados relacionais com SQL
- **JOIN federado** combina dados de diferentes fontes
- **DependÃªncia de configuraÃ§Ã£o** adequada do conector

### ğŸš¨ Troubleshooting de Conectores:
- **Problemas de credenciais** podem bloquear conectores federados
- **Caracteres especiais** em senhas podem causar falhas de parsing
- **ValidaÃ§Ã£o de conectores** Ã© essencial antes de executar queries
- **Issues de lab** podem ser problemas de infraestrutura, nÃ£o de cÃ³digo

### ğŸ“Š Consultas SQL AvanÃ§adas:
- **JOIN entre data sources** diferentes (DynamoDB + MySQL)
- **CAST()** para conversÃ£o de tipos entre fontes
- **Queries totalmente qualificadas** para evitar dependÃªncia de UI
- **DISTINCT** para evitar duplicatas em JOINs

## ğŸ† Resultado Final

### âŒ **Task 4 NÃƒO ConcluÃ­da**
- **Problema de infraestrutura** do lab impediu execuÃ§Ã£o
- **Conhecimento adquirido** sobre troubleshooting de conectores
- **Queries preparadas** para execuÃ§Ã£o apÃ³s correÃ§Ã£o do ambiente

### ğŸ“‹ PrÃ³ximos Passos:
1. **Aguardar correÃ§Ã£o** do ambiente de lab
2. **Reexecutar queries** apÃ³s correÃ§Ã£o do conector
3. **Submeter resultado** quando ambiente estiver funcional

---

**ğŸ’¡ ReflexÃ£o:** Esta task demonstra a importÃ¢ncia de troubleshooting de infraestrutura em ambientes de lab, onde problemas de provisionamento podem impedir a execuÃ§Ã£o de soluÃ§Ãµes tecnicamente corretas. O conhecimento sobre conectores federados e troubleshooting foi adquirido mesmo sem conclusÃ£o da task.